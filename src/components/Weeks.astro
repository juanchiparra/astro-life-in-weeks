---
const {
  birthDate,
  totalYears,
  weekData,
  sections,
  showBirthdays = true,
} = Astro.props as {
  birthDate: string;
  totalYears: number;
  weekData: { week: number; text: string; style: string }[];
  sections?: { title: string; startDate: string; endDate: string }[];
  showBirthdays?: boolean;
};

const startDate = new Date(birthDate);
startDate.setHours(0, 0, 0, 0);

const weekNumber = (date: string) => {
  const targetDate = new Date(date);
  const diffInMs = targetDate.getTime() - startDate.getTime();
  return Math.floor(diffInMs / (7 * 24 * 60 * 60 * 1000)) + 1;
};

const totalWeeks = sections
  ? Math.max(...sections.map((section) => weekNumber(section.endDate)))
  : Math.ceil(52.1775 * totalYears);

const birthdayWeeks = showBirthdays
  ? Array.from({ length: Math.ceil(totalWeeks / 52.1775) }).map((_, year) => {
      const birthday = new Date(startDate);
      birthday.setFullYear(startDate.getFullYear() + year);
      const diffInMs = birthday.getTime() - startDate.getTime();
      const weekNumber = Math.floor(diffInMs / (7 * 24 * 60 * 60 * 1000)) + 1;
      return weekNumber;
    })
  : [];

const weekTextMap = new Map(
  weekData.map((week) => [week.week, { text: week.text, style: week.style }]),
);

if (showBirthdays) {
  birthdayWeeks.forEach((week, index) => {
    const birthdayNumber = index;
    weekTextMap.set(week, { text: `ðŸŽ‰ ${birthdayNumber}`, style: "birthday" });
  });
}
---

<div class="weeks-container">
  {
    sections ? (
      sections.map((section) => {
        const startWeek = weekNumber(section.startDate);
        const endWeek = weekNumber(section.endDate);
        return (
          <div class="section">
            <h3>{section.title}</h3>
            <div class="weeks">
              {Array.from({ length: endWeek - startWeek + 1 }).map(
                (_, index) => {
                  const weekNumber = startWeek + index;
                  const weekData = weekTextMap.get(weekNumber) || {
                    text: "",
                    style: "",
                  };
                  const text = weekData.text;
                  const style = weekData.style;
                  return (
                    <div
                      class={`week ${style}`}
                      title={`Week ${weekNumber}`}
                      style={`flex: ${text ? "0 1 auto" : "0 0 15px"};`}
                    >
                      {text && <span>{text}</span>}
                    </div>
                  );
                },
              )}
            </div>
          </div>
        );
      })
    ) : (
      <div class="weeks">
        {Array.from({ length: totalWeeks }).map((_, index) => {
          const weekNumber = index + 1;
          const weekData = weekTextMap.get(weekNumber) || {
            text: "",
            style: "",
          };
          const text = weekData.text;
          const style = weekData.style;
          return (
            <div
              class={`week ${style}`}
              title={`Week ${weekNumber}`}
              style={`flex: ${text ? "0 1 auto" : "0 0 15px"};`}
            >
              {text && <span>{text}</span>}
            </div>
          );
        })}
      </div>
    )
  }
</div>

<style>
  .weeks-container {
    display: flex;
    flex-direction: column;
    gap: 0rem;
    padding: 1rem;
  }
  .weeks {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }

  .week {
    height: 32px;
    border: 1px solid var(--gray);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  .week span {
    padding: 0 15px;
  }

  .section h3 {
    margin-bottom: 1rem;
    font-size: var(--text-l);
    font-weight: 600;
  }
</style>
